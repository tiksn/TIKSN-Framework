using AntimalwareScanning;
using Autofac;
using Autofac.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using TIKSN.DependencyInjection;
using TIKSN.Platforms.Windows.DependencyInjection;
using TIKSN.Security.Antimalware;

var builder = Host.CreateDefaultBuilder(args);

builder.UseServiceProviderFactory(new AutofacServiceProviderFactory());

builder.ConfigureServices((hostContext, services) =>
{
    _ = services.AddFrameworkCore();
    _ = services.AddFrameworkPlatform();

    _ = services.AddHostedService<ScannerWorker>();

    _ = services.AddScoped<IScannerService, ScannerService>();
    _ = services.ConfigurePartial<AntimalwareScannerOptions>(hostContext.Configuration.GetSection("AntimalwareScanner"));
});

builder.ConfigureContainer<ContainerBuilder>(containerBuilder =>
{
    _ = containerBuilder.RegisterModule<CoreModule>();
    _ = containerBuilder.RegisterModule<PlatformModule>();
});

var app = builder.Build();

await app.RunAsync().ConfigureAwait(false);
